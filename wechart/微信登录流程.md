微信登录流程：

1：进入小程序 --> 通过 wx.login()获取到code:登录临时凭证，有效时间是5分钟:

2：前端请求wx.request()发送获取到的code;

3：服务端根据传过来的code组装为appid + appsecret + code 通过微信接口服务API校验 ，微信接口服务校验ok返回session_key（会话密钥, 服务端通过 [code2Session](https://link.juejin.im/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fopen-api%2Flogin%2Fcode2Session.html) 获取） +openid（用户在该小程序下的用户唯一标识, 永远不变, 服务端通过 code 获取）等参数；

```
// code 换取 openId 和 sessionKey 的主要逻辑
axios.get('https://api.weixin.qq.com/sns/jscode2session', {
  params: {
    appid: config.appId,
    secret: config.appSecret,
    js_code: code,
    grant_type: 'authorization_code'
  }
}).then(({data}) => {
  var openId = data.openid
  var user = users[openId]
  if (!user) {
  user = {
  openId,
  sessionKey: data.session_key
}
    users[openId] = user
    console.log('新用户', user)
} else {
	console.log('老用户', user)
}
  req.session.openId = user.openId
    req.user = user
      }).then(() => {
        res.send({
            code: 0
        })
  })
} else {
	throw new Error('未知的授权类型')
}
```

- `unionId` 用户在同一个微信开放平台帐号(公众号, 小程序, 网站, 移动应用)下的唯一标识, 永远不变
- `appId` 小程序唯一标识
- `appSecret` 小程序的 app secret, 可以和 code, appId 一起换取 session_key

4：服务端自定义登录状态与openid，session_key关联，然后返回自定义的登录态给前端；

5：前端根据接收到的登录态存入到storage；

6：每次前端请求数据wx.request()携带自定义的登录态给后端服务器；

7：后端根据前端发送的请求查询openid和session_key确定是否返回业务数据

8：完成整个业务流程

### 其他名词

- `rawData` 不包括敏感信息的原始数据字符串，用于计算签名
- `encryptedData` 包含敏感信息的用户信息, 是加密的
- `signature` 用于校验用户信息是否无篡改
- `iv` 加密算法的初始向量

手机号, openId, unionId, 可以看出这些值都可以唯一定位一个用户, 而昵称, 头像这些不能定位用户的都不是敏感信息

小程序登录相关函数：

- wx.login() 
- wx.getUserInfo
  - 如果已登录用户调用 getUserInfo 则返回用户信息, 比如昵称, 头像等, 如果未登录则返回"用户未登录"，也就是说此接口还有**判断用户是否登录**的功效.
- wx.checkSession

## 自定义登录态持久化

小程序自己的**持久化**接口, 也就是 setStorage 和 getStorage